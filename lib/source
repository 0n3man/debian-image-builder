# tmp
ALLSRC="sources"
AMLSRC="sources"
ROCSRC="sources"
BCMSRC="sources"

# output
BINPINE="../output/pine64"
BINTRI="../output/tritium"
BINODC4="../output/odroidc4"
BINODN2="../output/odroidn2"
BINODN2P="../output/odroidn2plus"
BINLEP="../output/lepotato"
BINNPI="../output/nanopi"
BINR1="../output/opir1"
BINRNG="../output/renegade"
BINR64="../output/rock64"
BINNPC="../output/nanopc"
BINRPI4="../output/raspi4"

CORES=`nproc`
DEF="../defconfig"

PACKAGING="../patches/packaging"
ALLWINNER="../patches/allwinner"
NANOPI="../patches/allwinner/nanopi"
SUN8I="../patches/allwinner/sun8i"
AMLOGIC="../patches/amlogic"
OC4UBOOT="../patches/amlogic/uboot/odroidc4"
ON2PUBOOT="../patches/amlogic/uboot/odroidn2plus"
PINE="../patches/allwinner/pine64"
RKUBOOT="../patches/rockchip/uboot"
RK3328="../patches/rockchip/3328"
RK3399="../patches/rockchip/3399"
BROADCOM="../patches/broadcom"
# do not edit above this line

# kernel
KERNEL="linux"

# stage1
IMGSIZE="1850MB"
IMGSIZE_UNSTABLE="2700MB"
RPISIZE="2000MB"
RPISIZE_UNSTABLE="2725MB"

# stage 2
PKGS1="tzdata keyboard-configuration sudo man-db dbus initramfs-tools \
       e2fsprogs u-boot-tools fonty-rg patch wget apt-transport-https \
       dirmngr rsync psmisc parted hdparm aria2 dosfstools pv"


PKGS2="bluetooth rfkill haveged resolvconf git build-essential net-tools \
       ifplugd fuse wpasupplicant wireless-tools usbutils alsa-utils gettext wget \
       mc nano figlet toilet curl dialog openssh-client openssh-server ntfs-3g bc \
       bison flex libssl-dev zram-tools python3 python3-setuptools avahi-utils \
       libncursesw5-dev autopoint autoconf automake pkg-config libtool fake-hwclock \
       distro-info-data lsb-release"

RPI="curl cmake zip unzip"
EEPROM_VERSION="11.0"

FIRMWARE="firmware-linux-nonfree firmware-linux \
          firmware-misc-nonfree firmware-realtek firmware-ralink"

# do not edit below this line
# uinitrd
uinitrd(){
cd ~
echo
echo Adding uInitrd script.
mkdir -p /etc/initramfs/post-update.d/
mv -f 99-uboot /etc/initramfs/post-update.d/
chmod +x /etc/initramfs/post-update.d/99-uboot
chown root:root /etc/initramfs/post-update.d/99-uboot
}

# wireless
rtl88x2bu_conf(){
mkdir -p /usr/lib/NetworkManager/conf.d/
tee /usr/lib/NetworkManager/conf.d/rtl88x2bu.conf <<EOF
# Certain drivers are known not to support changing the MAC address.
# Disable touching the MAC address on such devices.

[device-rtl88x2bu]
match-device=driver:rtl88x2bu
wifi.scan-rand-mac-address=no
wifi.cloned-mac-address=preserve
ethernet.cloned-mac-address=preserve
EOF
chown root:root /usr/lib/NetworkManager/conf.d/rtl88x2bu.conf
}

rtl8821cu_conf(){
mkdir -p /usr/lib/NetworkManager/conf.d/
tee /usr/lib/NetworkManager/conf.d/rtl8821cu.conf <<EOF
# Certain drivers are known not to support changing the MAC address.
# Disable touching the MAC address on such devices.

[device-rtl8821cu]
match-device=driver:rtl8821cu
wifi.scan-rand-mac-address=no
wifi.cloned-mac-address=preserve
ethernet.cloned-mac-address=preserve
EOF
chown root:root /usr/lib/NetworkManager/conf.d/rtl8821cu.conf
}

# zramswap
zramswap_config(){
sed -i 's/#ALLOCATION=256/ALLOCATION=1024/g' /etc/default/zramswap
sed -i 's/#SIZE=256/SIZE=1024/g' /etc/default/zramswap
sed -i 's/#PRIORITY=100/PRIORITY=100/g' /etc/default/zramswap
}

fetch_version(){
echo 'INSTALLED_KERNEL="' > /root/kernel1
cat /usr/src/linux-headers*/include/config/kernel.release > /root/kernel2
echo '"' > /root/kernel3
paste -d '\0' kernel1 kernel2 kernel3  > /root/kernel.txt
rm -f kernel1 kernel2 kernel3
}

rename_image(){
source kernel.txt
mv -f ${DEVICE_SOC}-debian-${DEBIAN_VERSION}-${IMAGE_DATE}.img ${DEVICE_SOC}-debian-${DEBIAN_VERSION}-${INSTALLED_KERNEL}-${IMAGE_DATE}.img
}

compress_image(){
source kernel.txt
mv -f ${DEVICE_SOC}-debian-${DEBIAN_VERSION}-${IMAGE_DATE}.img ${DEVICE_SOC}-debian-${DEBIAN_VERSION}-${INSTALLED_KERNEL}-${IMAGE_DATE}.img
xz -zevk --threads=${CORES} ${DEVICE_SOC}-debian-${DEBIAN_VERSION}-${INSTALLED_KERNEL}-${IMAGE_DATE}.img
}
