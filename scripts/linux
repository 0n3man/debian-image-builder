#!/bin/bash
source lib/function/echoes
source lib/source
validation
source lib/function/linux
source lib/function/linux-patching
source lib/function/compiler
source lib/function/wireless
source board.txt > /dev/null 2>&1
source userdata.txt > /dev/null 2>&1
LINUX_VERSION=`echo "$VERSION" | sed -e 's/^\(.\{4\}\).*/\1/' | sed 's/-//g'`

if [ $verbose -eq 1 ]; then
	set -x;
fi
if [ $ccache -eq 1 ]; then
	if [[ `command -v ccache` ]]; then
		rm -f {ccache.txt,gcc.txt};
		ccache_version;
	else
		sudo apt update;
		sudo apt upgrade -y;
		sudo apt install -y ccache;
		sleep 1s;
		rm -f {ccache.txt,gcc.txt};
		ccache_version;
	fi
fi
if [ $ccache -eq 0 ]; then
	rm -f {ccache.txt,gcc.txt};
	gcc_version;
fi
# sources directory
kernel_source
if [ -e ${KERNEL}-${VERSION} ]; then
	CAP_KERNEL=`echo "${KERNEL}" | sed -e "s/\b\(.\)/\u\1/g"`
	echo -en "${WHT}${CAP_KERNEL}-${VERSION}${FIN}";
	echo -en " ${PNK}[${FIN}${YLW}removing${FIN}${PNK}]${FIN} ";
	rm -fdr ${KERNEL}-${VERSION};
	echo -en "${PNK}[${FIN}${GRN}done${FIN}${PNK}]${FIN}";
fi
# download and extract
download
# setup
if [[ "$SETUP" == "vendor" ]]; then
	if [[ "$VERSION" == "4.9.y" ]]; then
		vendor_setup;
	else
		if [[ "$VERSION" == "4.19.y" ]]; then
			vendor_setup;
		else
			setup;
		fi
	fi
else
	setup;
fi
# amlogic patching
if [[ "$FAMILY" == "amlogic" ]]; then
	amlogic_patching;
fi
# allwinner patching
if [[ "$FAMILY" == "allwinner" ]]; then
	allwinner_patching;
fi
# broadcom patching
if [[ "$FAMILY" == "broadcom" ]]; then
	raspberrypi_patching;
fi
# rockchip patching
if [[ "$FAMILY" == "rockchip" ]]; then
	rockchip_patching;
fi
# samsung patching
if [[ "$FAMILY" == "samsung" ]]; then
	samsung_patching;
fi
# defconfig
if [[ "$SETUP" == "vendor" ]]; then
	if [ $custom_defconfig -eq 1 ]; then
		cconfig;
	else
		vendor_config;
	fi
else
	if [ $custom_defconfig -eq 1 ]; then
		cconfig;
	else
		bconfig;
	fi
fi
# menuconfig
if [ $menuconfig -eq 1 ]; then
	menuconfig;
fi

# builddeb
if [ $crosscompile -eq 1 ]; then
	ccompile;
else
	ncompile;
fi
echo ""
# finish
cd ..
rm -f {*linux-image-dbg*.deb,linux-libc-dev*.deb,*.buildinfo,*.changes}
if [[ `ls ../${OUTPUT}/*.deb` ]] > /dev/null 2>&1; then
	mkdir -p ../${OUTPUT}/tmp;
	mv -f ../${OUTPUT}/*.deb ../${OUTPUT}/tmp;
fi
mkdir -p ../${OUTPUT}
mv -f *.deb ../${OUTPUT}/
if [ -f ../github.txt ]; then
	rm -f ../github.txt;
fi
echo_done
exit 0
