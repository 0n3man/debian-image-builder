From 3c6d5040be42a6c9810e3192788ff05d15649dc9 Mon Sep 17 00:00:00 2001
From: Shantur Rathore <i@shantur.com>
Date: Sat, 10 Feb 2024 21:04:18 -0500
Subject: [PATCH] Fix: common: usb_hub: Reset only USB3.0 hub

USB 3.0 spec requires hub to reset device while
enumeration. Some USB 2.0 hubs / devices don't
handle this well and after implementation of
reset some USB 2.0 disks weren't detected on
Allwinner based boards.

Resetting only when hub is USB 3.0 fixes it.

Tested-by: Andre Przywara <andre.przywara@arm.com>
Signed-off-by: Shantur Rathore <i@shantur.com>
Signed-off-by: Patrick Yavitz <pyavitz@xxxxx.com>
---
 common/usb_hub.c | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/common/usb_hub.c b/common/usb_hub.c
index ba11a188ca..e6797c4e50 100644
--- a/common/usb_hub.c
+++ b/common/usb_hub.c
@@ -172,8 +172,10 @@ static void usb_hub_power_on(struct usb_hub_device *hub)
 
 	debug("enabling power on all ports\n");
 	for (i = 0; i < dev->maxchild; i++) {
-		usb_set_port_feature(dev, i + 1, USB_PORT_FEAT_POWER);
-		debug("port %d returns %lX\n", i + 1, dev->status);
+		if (usb_hub_is_superspeed(dev)) {
+			usb_set_port_feature(dev, i + 1, USB_PORT_FEAT_RESET);
+			debug("Reset : port %d returns %lX\n", i + 1, dev->status);
+		}
 	}
 
 #ifdef CONFIG_SANDBOX
-- 
2.39.2

