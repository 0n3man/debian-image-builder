From 41499876c85f19ff73b4450eca69bf3405a9d4a9 Mon Sep 17 00:00:00 2001
From: James Deng <james.deng@spacemit.com>
Date: Sat, 20 Jul 2024 11:42:38 +0800
Subject: [PATCH] Update for v1.0.9

---
 board/spacemit/k1-x/k1x.c             |  3 +-
 cmd/spacemit_flash.c                  | 49 ++++++++++++++++++++++++++-
 configs/k1_defconfig                  |  2 +-
 drivers/fastboot/fb_mmc.c             |  7 ----
 drivers/video/spacemit/spacemit_edp.c | 15 ++++----
 5 files changed, 57 insertions(+), 19 deletions(-)

diff --git a/board/spacemit/k1-x/k1x.c b/board/spacemit/k1-x/k1x.c
index bf5f20a8..3ca98857 100644
--- a/board/spacemit/k1-x/k1x.c
+++ b/board/spacemit/k1-x/k1x.c
@@ -1112,8 +1112,7 @@ int ft_board_setup(void *blob, struct bd_info *bd)
 		mem.start = gd->video_bottom;
 		mem.end = gd->video_top - 1;
 
-		fdtdec_add_reserved_memory(blob, "framebuffer", &mem, NULL, 0, NULL,
-			FDTDEC_RESERVED_MEMORY_NO_MAP);
+		fdtdec_add_reserved_memory(blob, "framebuffer", &mem, NULL, 0, NULL, 0);
 	}
 
 	ft_board_cpu_fixup(blob, bd);
diff --git a/cmd/spacemit_flash.c b/cmd/spacemit_flash.c
index 33bf34cc..6e9229c0 100644
--- a/cmd/spacemit_flash.c
+++ b/cmd/spacemit_flash.c
@@ -30,6 +30,51 @@
 #include <nvme.h>
 #include <watchdog.h>
 
+
+#define SUCCESS_BANNER \
+	"\r\n" \
+	"\r\n" \
+	"\tPPPPPPPPPPPPPPPPP        AAA                 SSSSSSSSSSSSSSS    SSSSSSSSSSSSSSS  \r\n" \
+	"\tP::::::::::::::::P      A:::A              SS:::::::::::::::S SS:::::::::::::::S \r\n" \
+	"\tP::::::PPPPPP:::::P    A:::::A            S:::::SSSSSS::::::SS:::::SSSSSS::::::S \r\n" \
+	"\tPP:::::P     P:::::P  A:::::::A           S:::::S     SSSSSSSS:::::S     SSSSSSS \r\n" \
+	"\t  P::::P     P:::::P A:::::::::A          S:::::S            S:::::S             \r\n" \
+	"\t  P::::P     P:::::PA:::::A:::::A         S:::::S            S:::::S             \r\n" \
+	"\t  P::::PPPPPP:::::PA:::::A A:::::A         S::::SSSS          S::::SSSS          \r\n" \
+	"\t  P:::::::::::::PPA:::::A   A:::::A         SS::::::SSSSS      SS::::::SSSSS     \r\n" \
+	"\t  P::::PPPPPPPPP A:::::A     A:::::A          SSS::::::::SS      SSS::::::::SS   \r\n" \
+	"\t  P::::P        A:::::AAAAAAAAA:::::A            SSSSSS::::S        SSSSSS::::S  \r\n" \
+	"\t  P::::P       A:::::::::::::::::::::A                S:::::S            S:::::S \r\n" \
+	"\t  P::::P      A:::::AAAAAAAAAAAAA:::::A               S:::::S            S:::::S \r\n" \
+	"\tPP::::::PP   A:::::A             A:::::A  SSSSSSS     S:::::SSSSSSSS     S:::::S \r\n" \
+	"\tP::::::::P  A:::::A               A:::::A S::::::SSSSSS:::::SS::::::SSSSSS:::::S \r\n" \
+	"\tP::::::::P A:::::A                 A:::::AS:::::::::::::::SS S:::::::::::::::SS  \r\n" \
+	"\tPPPPPPPPPPAAAAAAA                   AAAAAAASSSSSSSSSSSSSSS    SSSSSSSSSSSSSSS    \r\n" \
+	"\r\n" \
+	"\r\n"
+
+#define FAIL_BANNER \
+	"\r\n" \
+	"\r\n" \
+	"\tFFFFFFFFFFFFFFFFFFFFFF      AAA               IIIIIIIIIILLLLLLLLLLL             \r\n" \
+	"\tF::::::::::::::::::::F     A:::A              I::::::::IL:::::::::L             \r\n" \
+	"\tF::::::::::::::::::::F    A:::::A             I::::::::IL:::::::::L             \r\n" \
+	"\tFF::::::FFFFFFFFF::::F   A:::::::A            II::::::IILL:::::::LL             \r\n" \
+	"\t  F:::::F       FFFFFF  A:::::::::A             I::::I    L:::::L               \r\n" \
+	"\t  F:::::F              A:::::A:::::A            I::::I    L:::::L               \r\n" \
+	"\t  F::::::FFFFFFFFFF   A:::::A A:::::A           I::::I    L:::::L               \r\n" \
+	"\t  F:::::::::::::::F  A:::::A   A:::::A          I::::I    L:::::L               \r\n" \
+	"\t  F:::::::::::::::F A:::::A     A:::::A         I::::I    L:::::L               \r\n" \
+	"\t  F::::::FFFFFFFFFFA:::::AAAAAAAAA:::::A        I::::I    L:::::L               \r\n" \
+	"\t  F:::::F         A:::::::::::::::::::::A       I::::I    L:::::L               \r\n" \
+	"\t  F:::::F        A:::::AAAAAAAAAAAAA:::::A      I::::I    L:::::L         LLLLLL\r\n" \
+	"\tFF:::::::FF     A:::::A             A:::::A   II::::::IILL:::::::LLLLLLLLL:::::L\r\n" \
+	"\tF::::::::FF    A:::::A               A:::::A  I::::::::IL::::::::::::::::::::::L\r\n" \
+	"\tF::::::::FF   A:::::A                 A:::::A I::::::::IL::::::::::::::::::::::L\r\n" \
+	"\tFFFFFFFFFFF  AAAAAAA                   AAAAAAAIIIIIIIIIILLLLLLLLLLLLLLLLLLLLLLLL\r\n" \
+	"\r\n" \
+	"\r\n"
+
 static int dev_emmc_num = -1;
 static int dev_sdio_num = -1;
 static u32 bootfs_part_index = 0;
@@ -356,9 +401,11 @@ static int load_from_device(struct cmd_tbl *cmdtp, char *load_str,
 void recovery_show_result(struct flash_dev *fdev, int ret)
 {
 	if (ret) {
-		printf("!!!!!!!!!!!!!!!!!!! recovery flash false !!!!!!!!!!!!!!!!!!!\n");
+		printf("!!!!!!!!!!!!!!!!!!! recovery flash failed !!!!!!!!!!!!!!!!!!!\n");
+		puts(FAIL_BANNER);
 	} else {
 		printf("################### recovery flash success ###################\n");
+		puts(SUCCESS_BANNER);
 	}
 
 	/*free the malloc paramenter*/
diff --git a/configs/k1_defconfig b/configs/k1_defconfig
index b9f05568..52e25266 100644
--- a/configs/k1_defconfig
+++ b/configs/k1_defconfig
@@ -242,7 +242,7 @@ CONFIG_USB_GADGET_PRODUCT_NUM=0x1001
 CONFIG_USB2_K1X_CI=y
 # CONFIG_USB_SET_SERIAL_NUMBER is not set
 CONFIG_DM_VIDEO=y
-CONFIG_VIDEO_PCI_DEFAULT_FB_SIZE=0x8000000
+CONFIG_VIDEO_PCI_DEFAULT_FB_SIZE=0x1000000
 CONFIG_VIDEO_COPY=y
 CONFIG_SYS_WHITE_ON_BLACK=y
 CONFIG_DISPLAY=y
diff --git a/drivers/fastboot/fb_mmc.c b/drivers/fastboot/fb_mmc.c
index 3910f053..26e45f4a 100644
--- a/drivers/fastboot/fb_mmc.c
+++ b/drivers/fastboot/fb_mmc.c
@@ -544,13 +544,6 @@ void fastboot_mmc_flash_write(const char *cmd, void *download_buffer,
 		printf("init fdev success\n");
 	}
 
-	/* flash env */
-	/*if (strcmp(cmd, "env") == 0) {*/
-	/*	printf("flash env to emmc\n");*/
-	/*	fastboot_oem_flash_env(cmd, fastboot_buf_addr, download_bytes,*/
-	/*							response, fdev);*/
-	/*	return;*/
-	/*}*/
 	if (strcmp(cmd, "bootinfo") == 0) {
 		printf("flash bootinfo\n");
 		fastboot_oem_flash_bootinfo(cmd, fastboot_buf_addr, download_bytes,
diff --git a/drivers/video/spacemit/spacemit_edp.c b/drivers/video/spacemit/spacemit_edp.c
index e6edabfd..8b4ecdb4 100644
--- a/drivers/video/spacemit/spacemit_edp.c
+++ b/drivers/video/spacemit/spacemit_edp.c
@@ -162,8 +162,7 @@ void Reset_LT8911EXB(struct udevice *dev)
 	dm_gpio_set_value(&priv->reset_gpio, 0);
 	mdelay(50);
 	dm_gpio_set_value(&priv->reset_gpio, 1);
-	mdelay(150);
-
+	mdelay(100);
 }
 
 void LT8911EX_ChipID(struct udevice *dev)                                          // read Chip ID
@@ -271,21 +270,16 @@ static int lt8911exb_i2c_test(struct udevice *dev)                            //
 
     while(retry++ < 3) {
         ret = edp_panel_i2c_write(dev, 0xff, 0x81);
-
         if(ret < 0) {
             pr_info("LT8911EXB i2c test write addr:0xff failed\n");
             continue;
         }
-        edp_panel_i2c_read(dev, 0xff, &chip_id_l);
 
         ret = edp_panel_i2c_write(dev, 0x08, 0x7f);
-
         if(ret < 0) {
             pr_info("LT8911EXB i2c test write addr:0x08 failed\n");
             continue;
         }
-        edp_panel_i2c_read(dev, 0x01, &chip_id_m);
-        pr_debug("LT8911EXB i2c test success chipid: 0x%x,0x%x\n", chip_id_m, chip_id_l);
 
         edp_panel_i2c_read(dev, 0x00, &chip_id_l);
         edp_panel_i2c_read(dev, 0x01, &chip_id_m);
@@ -1072,7 +1066,6 @@ static int edp_panel_enable_backlight(struct udevice *dev)
 
 	PCR_Status(dev);			// just for Check PCR CLK
 
-	dm_gpio_set_value(&priv->enable_gpio, 1);
 	dm_gpio_set_value(&priv->bl_gpio, 1);
 
 	return 0;
@@ -1129,6 +1122,12 @@ static int edp_panel_probe(struct udevice *dev)
 
 	dm_gpio_set_value(&priv->standby_gpio, 1);
 	mdelay(50);
+	dm_gpio_set_value(&priv->standby_gpio, 0);
+	mdelay(50);
+	dm_gpio_set_value(&priv->standby_gpio, 1);
+	mdelay(100);
+
+	dm_gpio_set_value(&priv->enable_gpio, 1);
 
 	Reset_LT8911EXB(dev);
 
-- 
2.39.2

