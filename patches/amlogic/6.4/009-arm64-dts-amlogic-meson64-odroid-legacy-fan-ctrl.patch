From 25710b1eae2e549e97e946f27ce5cb63e6d8748a Mon Sep 17 00:00:00 2001
From: Patrick Yavitz <pyavitz@xxxxx.com>
Date: Wed, 26 Jul 2023 10:50:56 -0400
Subject: [PATCH] arm64: dts: amlogic: meson64 odroid legacy fan ctrl

Linux 6.4.y

meson64_odroidn2l
meson64_odroidn2_plus

Signed-off-by: Patrick Yavitz <pyavitz@xxxxx.com>
---
 .../dts/amlogic/meson64_odroidn2_plus.dts     | 29 +++++++++++++++++--
 .../boot/dts/amlogic/meson64_odroidn2l.dts    | 27 ++++++++++++++++-
 2 files changed, 53 insertions(+), 3 deletions(-)

diff --git a/arch/arm64/boot/dts/amlogic/meson64_odroidn2_plus.dts b/arch/arm64/boot/dts/amlogic/meson64_odroidn2_plus.dts
index 832aeea381e0..d9c3467451dc 100644
--- a/arch/arm64/boot/dts/amlogic/meson64_odroidn2_plus.dts
+++ b/arch/arm64/boot/dts/amlogic/meson64_odroidn2_plus.dts
@@ -11,14 +11,14 @@
 #include "meson-g12b-odroid-n2-plus.dts"
 
 / {
-	pwmgpio:pwmgpio {
+	pwmgpio: pwmgpio {
 		compatible = "pwm-gpio";
 		#pwm-cells = <3>;
 		pwm-gpios = <&gpio_ao GPIOAO_10 GPIO_ACTIVE_HIGH>;
 		status = "okay";
 	};
 
-	pwmfan:pwm-fan {
+	pwmfan: pwmfan {
 		compatible = "pwm-fan";
 		pwms = <&pwmgpio 0 40000 PWM_POLARITY_INVERTED>;
 		cooling-min-state = <0>;
@@ -64,6 +64,31 @@ &vddcpu_b {
 	pwms = <&pwm_AO_cd 1 1500 0>;
 };
 
+&cpu_thermal {
+	trips {
+		fan_0: trip-point@0 {
+			temperature = <65000>;
+			hysteresis = <5000>;
+			type = "active";
+		};
+		fan_1: trip-point@1 {
+			temperature = <75000>;
+			hysteresis = <5000>;
+			type = "active";
+		};
+	};
+	cooling-maps {
+		fan_cooling_map0 {
+			trip = <&fan_0>;
+			cooling-device = <&pwmfan THERMAL_NO_LIMIT 2>;
+		};
+		fan_cooling_map1 {
+			trip = <&fan_1>;
+			cooling-device = <&pwmfan 2 THERMAL_NO_LIMIT>;
+		};
+	};
+};
+
 &cpu_opp_table_0 {
 	/delete-node/ opp-100000000;
 	/delete-node/ opp-250000000;
diff --git a/arch/arm64/boot/dts/amlogic/meson64_odroidn2l.dts b/arch/arm64/boot/dts/amlogic/meson64_odroidn2l.dts
index ee40f69f2ec1..ffd13ef45988 100644
--- a/arch/arm64/boot/dts/amlogic/meson64_odroidn2l.dts
+++ b/arch/arm64/boot/dts/amlogic/meson64_odroidn2l.dts
@@ -24,7 +24,7 @@ pwmgpio: pwmgpio {
 		status = "okay";
 	};
 
-	pwm-fan {
+	pwmfan: pwmfan {
 		compatible = "pwm-fan";
 		pwms = <&pwmgpio 0 40000 PWM_POLARITY_INVERTED>;
 		cooling-min-state = <0>;
@@ -47,6 +47,31 @@ &reboot {
 	sd-vqen = <&gpio_ao GPIOAO_3 GPIO_ACTIVE_HIGH>;
 };
 
+&cpu_thermal {
+	trips {
+		fan_0: trip-point@0 {
+			temperature = <65000>;
+			hysteresis = <5000>;
+			type = "active";
+		};
+		fan_1: trip-point@1 {
+			temperature = <75000>;
+			hysteresis = <5000>;
+			type = "active";
+		};
+	};
+	cooling-maps {
+		fan_cooling_map0 {
+			trip = <&fan_0>;
+			cooling-device = <&pwmfan THERMAL_NO_LIMIT 2>;
+		};
+		fan_cooling_map1 {
+			trip = <&fan_1>;
+			cooling-device = <&pwmfan 2 THERMAL_NO_LIMIT>;
+		};
+	};
+};
+
 &cpu_opp_table_0 {
 	/delete-node/ opp-100000000;
 	/delete-node/ opp-250000000;
-- 
2.39.2

