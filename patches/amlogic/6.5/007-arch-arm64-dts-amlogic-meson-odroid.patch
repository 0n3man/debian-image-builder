From 234e5edc547be9694f7d9b2c5b455c20bc63e485 Mon Sep 17 00:00:00 2001
From: Patrick Yavitz <pyavitz@xxxxx.com>
Date: Thu, 17 Aug 2023 23:37:36 -0400
Subject: [PATCH] arch: arm64: dts: amlogic: meson-odroid

Signed-off-by: Patrick Yavitz <pyavitz@xxxxx.com>
---
 .../dts/amlogic/meson-g12b-odroid-n2-plus.dts | 56 +++++++++++++++++++
 .../boot/dts/amlogic/meson-g12b-odroid-n2.dts | 13 +++++
 .../dts/amlogic/meson-g12b-odroid-n2l.dts     | 46 ++++++++++++++-
 .../boot/dts/amlogic/meson-g12b-odroid.dtsi   | 37 +++++++++++-
 .../boot/dts/amlogic/meson-sm1-odroid-c4.dts  | 21 +++++++
 .../boot/dts/amlogic/meson-sm1-odroid-hc4.dts | 28 ++++++++++
 .../boot/dts/amlogic/meson-sm1-odroid.dtsi    | 38 +++++++++++++
 7 files changed, 237 insertions(+), 2 deletions(-)

diff --git a/arch/arm64/boot/dts/amlogic/meson-g12b-odroid-n2-plus.dts b/arch/arm64/boot/dts/amlogic/meson-g12b-odroid-n2-plus.dts
index ce1198ad34e4..66954111fbab 100644
--- a/arch/arm64/boot/dts/amlogic/meson-g12b-odroid-n2-plus.dts
+++ b/arch/arm64/boot/dts/amlogic/meson-g12b-odroid-n2-plus.dts
@@ -9,10 +9,39 @@
 /* The Amlogic S922X Rev. C supports the same OPPs as the A311D variant */
 #include "meson-g12b-a311d.dtsi"
 #include "meson-g12b-odroid-n2.dtsi"
+#include <dt-bindings/pwm/pwm.h>
 
 / {
 	compatible = "hardkernel,odroid-n2-plus", "amlogic,s922x", "amlogic,g12b";
 	model = "Hardkernel ODROID-N2Plus";
+
+	pwmgpio: pwmgpio {
+		compatible = "pwm-gpio";
+		#pwm-cells = <3>;
+		pwm-gpios = <&gpio_ao GPIOAO_10 GPIO_ACTIVE_HIGH>;
+		status = "okay";
+	};
+
+	pwmfan: pwmfan {
+		compatible = "pwm-fan";
+		pwms = <&pwmgpio 0 40000 PWM_POLARITY_INVERTED>;
+		cooling-min-state = <0>;
+		cooling-max-state = <3>;
+		#cooling-cells = <2>;
+		cooling-levels = <0 120 170 220>;
+	};
+};
+
+&ethmac {
+	/delete-property/	resets;
+	/delete-property/	reset-names;
+};
+
+&gpu_opp_table {
+	opp-999999984 {
+		opp-hz = /bits/ 64 <999999984>;
+		opp-microvolt = <800000>;
+	};
 };
 
 &vddcpu_a {
@@ -29,3 +58,30 @@ &vddcpu_b {
 	pwms = <&pwm_AO_cd 1 1500 0>;
 };
 
+&cpu_thermal {
+	trips {
+		fan_0: trip-point@0 {
+			temperature = <65000>;
+			hysteresis = <5000>;
+			type = "active";
+		};
+
+		fan_1: trip-point@1 {
+			temperature = <75000>;
+			hysteresis = <5000>;
+			type = "active";
+		};
+	};
+
+	cooling-maps {
+		fan_cooling_map0 {
+			trip = <&fan_0>;
+			cooling-device = <&pwmfan THERMAL_NO_LIMIT 2>;
+		};
+
+		fan_cooling_map1 {
+			trip = <&fan_1>;
+			cooling-device = <&pwmfan 2 THERMAL_NO_LIMIT>;
+		};
+	};
+};
diff --git a/arch/arm64/boot/dts/amlogic/meson-g12b-odroid-n2.dts b/arch/arm64/boot/dts/amlogic/meson-g12b-odroid-n2.dts
index a198a91259ec..091b1cf2a5d2 100644
--- a/arch/arm64/boot/dts/amlogic/meson-g12b-odroid-n2.dts
+++ b/arch/arm64/boot/dts/amlogic/meson-g12b-odroid-n2.dts
@@ -8,8 +8,21 @@
 
 #include "meson-g12b-s922x.dtsi"
 #include "meson-g12b-odroid-n2.dtsi"
+#include <dt-bindings/pwm/pwm.h>
 
 / {
 	compatible = "hardkernel,odroid-n2", "amlogic,s922x", "amlogic,g12b";
 	model = "Hardkernel ODROID-N2";
 };
+
+&ethmac {
+	/delete-property/	resets;
+	/delete-property/	reset-names;
+};
+
+&gpu_opp_table {
+	opp-999999984 {
+		opp-hz = /bits/ 64 <999999984>;
+		opp-microvolt = <800000>;
+	};
+};
diff --git a/arch/arm64/boot/dts/amlogic/meson-g12b-odroid-n2l.dts b/arch/arm64/boot/dts/amlogic/meson-g12b-odroid-n2l.dts
index 70919f40d597..b5a4f1cc9c66 100644
--- a/arch/arm64/boot/dts/amlogic/meson-g12b-odroid-n2l.dts
+++ b/arch/arm64/boot/dts/amlogic/meson-g12b-odroid-n2l.dts
@@ -8,11 +8,28 @@
 /* The Amlogic S922X Rev. C supports the same OPPs as the A311D variant */
 #include "meson-g12b-a311d.dtsi"
 #include "meson-g12b-odroid.dtsi"
+#include <dt-bindings/pwm/pwm.h>
 
 / {
 	compatible = "hardkernel,odroid-n2l", "amlogic,s922x", "amlogic,g12b";
 	model = "Hardkernel ODROID-N2L";
 
+	pwmgpio: pwmgpio {
+		compatible = "pwm-gpio";
+		#pwm-cells = <3>;
+		pwm-gpios = <&gpio_ao GPIOAO_10 GPIO_ACTIVE_HIGH>;
+		status = "okay";
+	};
+
+	pwmfan: pwmfan {
+		compatible = "pwm-fan";
+		pwms = <&pwmgpio 0 40000 PWM_POLARITY_INVERTED>;
+		cooling-min-state = <0>;
+		cooling-max-state = <3>;
+		#cooling-cells = <2>;
+		cooling-levels = <0 120 170 220>;
+	};
+
 	sound {
 		compatible = "amlogic,axg-sound-card";
 		model = "ODROID-N2L";
@@ -46,7 +63,6 @@ sound {
 		assigned-clock-rates = <294912000>,
 				       <270950400>,
 				       <393216000>;
-		status = "okay";
 
 		dai-link-0 {
 			sound-dai = <&frddr_a>;
@@ -98,6 +114,34 @@ codec {
 	};
 };
 
+&cpu_thermal {
+	trips {
+		fan_0: trip-point@0 {
+			temperature = <65000>;
+			hysteresis = <5000>;
+			type = "active";
+		};
+
+		fan_1: trip-point@1 {
+			temperature = <75000>;
+			hysteresis = <5000>;
+			type = "active";
+		};
+	};
+
+	cooling-maps {
+		fan_cooling_map0 {
+			trip = <&fan_0>;
+			cooling-device = <&pwmfan THERMAL_NO_LIMIT 2>;
+		};
+
+		fan_cooling_map1 {
+			trip = <&fan_1>;
+			cooling-device = <&pwmfan 2 THERMAL_NO_LIMIT>;
+		};
+	};
+};
+
 &eth_phy {
 	status = "disabled";
 };
diff --git a/arch/arm64/boot/dts/amlogic/meson-g12b-odroid.dtsi b/arch/arm64/boot/dts/amlogic/meson-g12b-odroid.dtsi
index 9e12a34b2840..b549852d3d40 100644
--- a/arch/arm64/boot/dts/amlogic/meson-g12b-odroid.dtsi
+++ b/arch/arm64/boot/dts/amlogic/meson-g12b-odroid.dtsi
@@ -12,6 +12,9 @@
 / {
 	aliases {
 		serial0 = &uart_AO;
+		serial1 = &uart_A;
+		serial2 = &uart_B;
+		serial3 = &uart_C;
 		ethernet0 = &ethmac;
 		rtc1 = &vrtc;
 	};
@@ -20,6 +23,16 @@ chosen {
 		stdout-path = "serial0:115200n8";
 	};
 
+	reboot: meson64-reboot {
+		compatible = "meson64,reboot";
+		sys_reset = <0x84000009>;
+		sys_poweroff = <0x84000008>;
+
+		sd-vmmc = <&gpio_ao GPIOAO_8 GPIO_ACTIVE_HIGH>;
+		sd-vqen = <&gpio_ao GPIOAO_3 GPIO_ACTIVE_HIGH>;
+		sd-vqsw = <&gpio_ao GPIOAO_9 GPIO_ACTIVE_HIGH>;
+	};
+
 	memory@0 {
 		device_type = "memory";
 		reg = <0x0 0x0 0x0 0x40000000>;
@@ -354,7 +367,11 @@ &sd_emmc_b {
 
 	bus-width = <4>;
 	cap-sd-highspeed;
-	max-frequency = <50000000>;
+	max-frequency = <200000000>;
+	sd-uhs-sdr12;
+	sd-uhs-sdr25;
+	sd-uhs-sdr50;
+	sd-uhs-sdr104;
 	disable-wp;
 
 	cd-gpios = <&gpio GPIOC_6 GPIO_ACTIVE_LOW>;
@@ -430,12 +447,30 @@ &toddr_c {
 	status = "okay";
 };
 
+&uart_A {
+	status = "disabled";
+	pinctrl-names = "default";
+	pinctrl-0 = <&uart_a_pins>;
+};
+
 &uart_AO {
 	status = "okay";
 	pinctrl-0 = <&uart_ao_a_pins>;
 	pinctrl-names = "default";
 };
 
+&uart_B {
+	status = "disabled";
+	pinctrl-names = "default";
+	pinctrl-0 = <&uart_b_pins>;
+};
+
+&uart_C {
+	status = "disabled";
+	pinctrl-names = "default";
+	pinctrl-0 = <&uart_c_pins>;
+};
+
 &usb {
 	status = "okay";
 };
diff --git a/arch/arm64/boot/dts/amlogic/meson-sm1-odroid-c4.dts b/arch/arm64/boot/dts/amlogic/meson-sm1-odroid-c4.dts
index d04768a66bfe..8d97e208745f 100644
--- a/arch/arm64/boot/dts/amlogic/meson-sm1-odroid-c4.dts
+++ b/arch/arm64/boot/dts/amlogic/meson-sm1-odroid-c4.dts
@@ -56,3 +56,24 @@ hub_3_0: hub@2 {
 &ir {
 	linux,rc-map-name = "rc-odroid";
 };
+
+&ethmac {
+	/delete-property/	resets;
+	/delete-property/	reset-names;
+};
+
+&external_phy {
+	/delete-property/	interrupts;
+	/delete-property/	interrupts-parent;
+};
+
+&gpu_opp_table {
+	opp-999999984 {
+		opp-hz = /bits/ 64 <999999984>;
+		opp-microvolt = <800000>;
+	};
+};
+
+&vddcpu {
+	regulator-max-microvolt = <1030000>;
+};
diff --git a/arch/arm64/boot/dts/amlogic/meson-sm1-odroid-hc4.dts b/arch/arm64/boot/dts/amlogic/meson-sm1-odroid-hc4.dts
index 74088e7280fe..fcb1cab9832b 100644
--- a/arch/arm64/boot/dts/amlogic/meson-sm1-odroid-hc4.dts
+++ b/arch/arm64/boot/dts/amlogic/meson-sm1-odroid-hc4.dts
@@ -142,3 +142,31 @@ &usb {
 	phys = <&usb2_phy0>, <&usb2_phy1>;
 	phy-names = "usb2-phy0", "usb2-phy1";
 };
+
+&ethmac {
+	/delete-property/	resets;
+	/delete-property/	reset-names;
+};
+
+&external_phy {
+	/delete-property/	interrupts;
+	/delete-property/	interrupts-parent;
+};
+
+&fan0 {
+	fan-supply = <&vcc_5v>;
+	interrupt-parent = <&gpio_intc>;
+	interrupts = <84 IRQ_TYPE_EDGE_FALLING>;
+	pulses-per-revolutions = <2>;
+};
+
+&gpu_opp_table {
+	opp-999999984 {
+		opp-hz = /bits/ 64 <999999984>;
+		opp-microvolt = <800000>;
+	};
+};
+
+&vddcpu {
+	regulator-max-microvolt = <1030000>;
+};
diff --git a/arch/arm64/boot/dts/amlogic/meson-sm1-odroid.dtsi b/arch/arm64/boot/dts/amlogic/meson-sm1-odroid.dtsi
index 2fce44939f45..aa6bdb84817a 100644
--- a/arch/arm64/boot/dts/amlogic/meson-sm1-odroid.dtsi
+++ b/arch/arm64/boot/dts/amlogic/meson-sm1-odroid.dtsi
@@ -11,6 +11,10 @@
 / {
 	aliases {
 		serial0 = &uart_AO;
+		serial1 = &uart_A;
+		serial2 = &uart_B;
+		serial3 = &uart_C;
+		serial4 = &uart_AO_B;
 		ethernet0 = &ethmac;
 	};
 
@@ -18,6 +22,16 @@ chosen {
 		stdout-path = "serial0:115200n8";
 	};
 
+	reboot: meson64-reboot {
+		compatible = "meson64,reboot";
+		sys_reset = <0x84000009>;
+		sys_poweroff = <0x84000008>;
+
+		sd-vqen = <&gpio_ao GPIOE_2 GPIO_ACTIVE_HIGH>;
+		sd-vqsw = <&gpio_ao GPIOAO_6 GPIO_ACTIVE_HIGH>;
+		sd-vmmc = <&gpio_ao GPIOAO_3 GPIO_ACTIVE_HIGH>;
+	};
+
 	memory@0 {
 		device_type = "memory";
 		reg = <0x0 0x0 0x0 0x40000000>;
@@ -450,12 +464,36 @@ &tohdmitx {
 	status = "okay";
 };
 
+&uart_A {
+	status = "disabled";
+	pinctrl-names = "default";
+	pinctrl-0 = <&uart_a_pins>;
+};
+
 &uart_AO {
 	status = "okay";
 	pinctrl-0 = <&uart_ao_a_pins>;
 	pinctrl-names = "default";
 };
 
+&uart_AO_B {
+	status = "disabled";
+	pinctrl-names = "default";
+	pinctrl-0 = <&uart_ao_b_8_9_pins>;
+};
+
+&uart_B {
+	status = "disabled";
+	pinctrl-names = "default";
+	pinctrl-0 = <&uart_b_pins>;
+};
+
+&uart_C {
+	status = "disabled";
+	pinctrl-names = "default";
+	pinctrl-0 = <&uart_c_pins>;
+};
+
 &usb {
 	status = "okay";
 	vbus-supply = <&usb_pwr_en>;
-- 
2.39.2

From c6110ce097240213360b2186784a639563d03ee8 Mon Sep 17 00:00:00 2001
From: Patrick Yavitz <pyavitz@xxxxx.com>
Date: Thu, 17 Aug 2023 23:41:11 -0400
Subject: [PATCH] arch: arm64: dts: amlogic: legacy meson64_odroid

Signed-off-by: Patrick Yavitz <pyavitz@xxxxx.com>
---
 arch/arm64/boot/dts/amlogic/Makefile                  | 6 ++++++
 arch/arm64/boot/dts/amlogic/meson64_odroidc4.dts      | 1 +
 arch/arm64/boot/dts/amlogic/meson64_odroidhc4.dts     | 1 +
 arch/arm64/boot/dts/amlogic/meson64_odroidn2.dts      | 1 +
 arch/arm64/boot/dts/amlogic/meson64_odroidn2_plus.dts | 1 +
 arch/arm64/boot/dts/amlogic/meson64_odroidn2l.dts     | 1 +
 6 files changed, 11 insertions(+)
 create mode 120000 arch/arm64/boot/dts/amlogic/meson64_odroidc4.dts
 create mode 120000 arch/arm64/boot/dts/amlogic/meson64_odroidhc4.dts
 create mode 120000 arch/arm64/boot/dts/amlogic/meson64_odroidn2.dts
 create mode 120000 arch/arm64/boot/dts/amlogic/meson64_odroidn2_plus.dts
 create mode 120000 arch/arm64/boot/dts/amlogic/meson64_odroidn2l.dts

diff --git a/arch/arm64/boot/dts/amlogic/Makefile b/arch/arm64/boot/dts/amlogic/Makefile
index cd1c5b04890a..1ac29784076e 100644
--- a/arch/arm64/boot/dts/amlogic/Makefile
+++ b/arch/arm64/boot/dts/amlogic/Makefile
@@ -74,3 +74,9 @@ dtb-$(CONFIG_ARCH_MESON) += meson-sm1-odroid-hc4.dtb
 dtb-$(CONFIG_ARCH_MESON) += meson-sm1-sei610.dtb
 dtb-$(CONFIG_ARCH_MESON) += meson-sm1-x96-air-gbit.dtb
 dtb-$(CONFIG_ARCH_MESON) += meson-sm1-x96-air.dtb
+
+dtb-$(CONFIG_ARCH_MESON) += meson64_odroidc4.dtb
+dtb-$(CONFIG_ARCH_MESON) += meson64_odroidhc4.dtb
+dtb-$(CONFIG_ARCH_MESON) += meson64_odroidn2.dtb
+dtb-$(CONFIG_ARCH_MESON) += meson64_odroidn2l.dtb
+dtb-$(CONFIG_ARCH_MESON) += meson64_odroidn2_plus.dtb
diff --git a/arch/arm64/boot/dts/amlogic/meson64_odroidc4.dts b/arch/arm64/boot/dts/amlogic/meson64_odroidc4.dts
new file mode 120000
index 000000000000..affc1b9e6a7b
--- /dev/null
+++ b/arch/arm64/boot/dts/amlogic/meson64_odroidc4.dts
@@ -0,0 +1 @@
+meson-sm1-odroid-c4.dts
\ No newline at end of file
diff --git a/arch/arm64/boot/dts/amlogic/meson64_odroidhc4.dts b/arch/arm64/boot/dts/amlogic/meson64_odroidhc4.dts
new file mode 120000
index 000000000000..89452b9881df
--- /dev/null
+++ b/arch/arm64/boot/dts/amlogic/meson64_odroidhc4.dts
@@ -0,0 +1 @@
+meson-sm1-odroid-hc4.dts
\ No newline at end of file
diff --git a/arch/arm64/boot/dts/amlogic/meson64_odroidn2.dts b/arch/arm64/boot/dts/amlogic/meson64_odroidn2.dts
new file mode 120000
index 000000000000..db3e0301d04e
--- /dev/null
+++ b/arch/arm64/boot/dts/amlogic/meson64_odroidn2.dts
@@ -0,0 +1 @@
+meson-g12b-odroid-n2.dts
\ No newline at end of file
diff --git a/arch/arm64/boot/dts/amlogic/meson64_odroidn2_plus.dts b/arch/arm64/boot/dts/amlogic/meson64_odroidn2_plus.dts
new file mode 120000
index 000000000000..69836a69d3cc
--- /dev/null
+++ b/arch/arm64/boot/dts/amlogic/meson64_odroidn2_plus.dts
@@ -0,0 +1 @@
+meson-g12b-odroid-n2-plus.dts
\ No newline at end of file
diff --git a/arch/arm64/boot/dts/amlogic/meson64_odroidn2l.dts b/arch/arm64/boot/dts/amlogic/meson64_odroidn2l.dts
new file mode 120000
index 000000000000..1d044acb5787
--- /dev/null
+++ b/arch/arm64/boot/dts/amlogic/meson64_odroidn2l.dts
@@ -0,0 +1 @@
+meson-g12b-odroid-n2l.dts
\ No newline at end of file
-- 
2.39.2

