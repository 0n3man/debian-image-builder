#!/bin/bash

### Functions
grow_mmcblk(){
bash growpart /dev/mmcblk0 1 > /dev/null 2>&1
sleep 1s
resize2fs /dev/mmcblk0p1 > /dev/null 2>&1
}

grow_mmcblk1(){
bash growpart /dev/mmcblk1 1 > /dev/null 2>&1
sleep 1s
resize2fs /dev/mmcblk1p1 > /dev/null 2>&1
}

grow_mmcblk2(){
bash growpart mmcblk2 1 > /dev/null 2>&1
sleep 1s
resize2fs mmcblk2p1 > /dev/null 2>&1
}

grow_sda(){
bash growpart /dev/sda 2 > /dev/null 2>&1
sleep 1s
resize2fs /dev/sda2 > /dev/null 2>&1
}

chk_mmcblk(){
fsck.fat -trawl /dev/mmcblk0p1 > /dev/null 2>&1
}

chk_mmcblk1(){
fsck.fat -trawl /dev/mmcblk1p1 > /dev/null 2>&1
}

chk_sda(){
fsck.fat -trawl /dev/sda1 > /dev/null 2>&1
}

fsck_boot(){
umount /boot
sleep 1s
if [ -e /dev/mmcblk0 ]; then
	chk_mmcblk;
else
	if [ -e /dev/mmcblk1 ]; then
		chk_mmcblk1;
	else
		if [ -e /dev/sda ]; then
			chk_sda;
		fi
	fi
fi
sleep 1s
mount /boot
}

### Grow Partition
if [ -e /dev/mmcblk0 ]; then
	grow_mmcblk;
else
	if [ -e /dev/mmcblk1 ]; then
		grow_mmcblk1;
	else
		if [ -e /dev/mmcblk2 ]; then
			grow_mmcblk2;
		else
			if [ -e /dev/sda ]; then
				grow_sda;
			fi
		fi
	fi
fi

### Fix boot partition
if [[ `blkid | grep -w vfat` ]]; then
	fsck_boot;
fi

### Clean up
systemctl disable firstboot
rm -f /var/cache/debconf/*
rm -f /usr/local/sbin/firstboot

exit
