#!/bin/bash

export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

BOOT=`findmnt -v -n -o SOURCE /boot`
ROOTFS=`findmnt -v -n -o SOURCE /`
GROW_SD=`findmnt -v -n -o SOURCE / | sed 's/./& /8'`
GROW_MMC=`findmnt -v -n -o SOURCE / | sed 's/p/ /'`

# Functions
partition_uuid(){
echo 'ROOT_PARTUUID="' > root1
blkid -o export -- $ROOTFS | sed -ne 's/^PARTUUID=//p' > root2
echo '"' > root3
paste -d '\0' root1 root2 root3  > /etc/opt/root-pid.txt
rm -f root1 root2 root3
}

extlinux(){
source /etc/opt/root-pid.txt
if [[ `grep -w "allwinner" "/etc/opt/board.txt"` ]]; then
	if [[ `grep -w "nanopineo" "/etc/opt/board.txt"` ]]; then
		BOARD="sun8i-h3-nanopi-neo.dtb";
	fi
	if [[ `grep -w "nanopim1" "/etc/opt/board.txt"` ]]; then
		BOARD="/boot/sun8i-h3-nanopi-m1.dtb";
	fi
	if [[ `grep -w "opione" "/etc/opt/board.txt"` ]]; then
		BOARD="sun8i-h3-orangepi-one.dtb";
	fi
	if [[ `grep -w "opipc" "/etc/opt/board.txt"` ]]; then
		BOARD="sun8i-h3-orangepi-pc.dtb";
	fi
	FAMILY="allwinner"
	CMDLINE="append earlyprintk console=tty1 console=ttyS0,115200n8 console=both rw root=PARTUUID=${ROOT_PARTUUID} rootwait rootfstype=ext4 fsck.repair=yes net.ifnames=0 loglevel=1 init=/sbin/init";
fi
FDT="/boot/${FAMILY}/${BOARD}";
FDTDIR="/boot/${FAMILY}/";
rm -f /boot/extlinux/extlinux.conf
tee /boot/extlinux/extlinux.conf <<EOF
label default
	kernel /boot/Image
	initrd /boot/uInitrd
	fdtdir ${FDTDIR}
	fdt ${FDT}
	#fdtoverlays
	${CMDLINE}
EOF
rm -f /etc/opt/root-pid.txt
}

# Expand root filesystem
if [[ `grep -w "Devuan" "/etc/os-release"` ]]; then
	echo "";
	echo -e " \e[0;31mExpanding root filesystem\e[0m ...";
fi
if [[ `findmnt -v -n -o SOURCE / | grep "mmc"` ]]; then
	bash growpart $GROW_MMC > /dev/null 2>&1;
fi
if [[ `findmnt -v -n -o SOURCE / | grep "sd"` ]]; then
	bash growpart $GROW_SD > /dev/null 2>&1;
fi
sleep 1s
resize2fs $ROOTFS > /dev/null 2>&1

# Fix PARTUUID
if [[ `grep -w "arm" "/etc/opt/board.txt"` ]]; then
	partition_uuid > /dev/null 2>&1;
	extlinux > /dev/null 2>&1;
fi

# Fsck boot partition
if [[ `findmnt -v -n /boot | grep -w "vfat"` ]]; then
	umount /boot;
	sleep 1s;
	bash fsck.fat -trawl $BOOT > /dev/null 2>&1;
	sleep 1s;
	mount /boot;
fi

### Clean up
if [[ `grep -w "Devuan" "/etc/os-release"` ]]; then
	update-rc.d firstboot remove;
	rm -f /etc/init.d/firstboot;
else
	systemctl disable firstboot;
fi
rm -f /var/cache/debconf/*
rm -f /usr/local/sbin/firstboot

exit 0
